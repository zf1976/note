###å‰è¨€

1. æ ¹æ®`token`è·å–è¯¥å±æ€§çš„ `Instance`

   åœ¨ä¸Šé¢ è§£æä¸­ï¼Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†`token` ï¼Œæˆ‘ä»¬çŸ¥é“ `token` é‡Œé¢åŒ…å«äº†`å±æ€§å`å’Œ `keys` ï¼Œæ¥ä¸‹æ¥å°±èƒ½é€šè¿‡`å±æ€§å`æ‹¿åˆ°`å±æ€§å€¼äº†`

   ```java
    Object value = getPropertyValue(tokens);
   ```

   ```java
   protected Object getPropertyValue(PropertyTokenHolder tokens) throws BeansException {
      String propertyName = tokens.canonicalName;
      String actualName = tokens.actualName;
      // [1] ç›´æ¥è·å– handler,handlerç”¨äºè®¿é—®å±æ€§
      PropertyHandler ph = getLocalPropertyHandler(actualName);
   ```

   ä¸Šé¢æåˆ°è¿‡ï¼Œ`PropertyHandler` æ˜¯ç”¨äºè®¿é—®å±æ€§çš„ï¼ŒèŒè´£åˆ†ç¦»å˜›ï¼Œæ‰€ä»¥å†æ‹¿åˆ°`token` åï¼Œå°±å¯ä»¥è·å– `Handler`äº†ã€‚è¿™ä¸ªæ–¹æ³•çš„å®ç°æ˜¯åœ¨`BeanWrapperImpl#getLocalPropertyHandler`ä¸­å®ç°çš„ã€‚

   ```java
   protected BeanPropertyHandler getLocalPropertyHandler(String propertyName) {
      // [1] å®ç°å¾ˆç®€å•ï¼Œç›´æ¥ä»ç¼“å­˜è·å–å±æ€§æè¿°ç¬¦
      PropertyDescriptor pd = getCachedIntrospectionResults().getPropertyDescriptor(propertyName);
      return (pd != null ? new BeanPropertyHandler(pd) : null);
   }
   ```

   å–„ç”¨ç¼“å­˜ï½:happy:  ï¼Œè¿˜è®°å¾— `getCachedIntrospectionResults` è¿™ä¸ªæ–¹æ³•ä¹ˆï¼Œä»`ç¼“å­˜`æˆ–è€…ä»`çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨`

   æ‹¿åˆ° `BeanInfo`ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦åˆ° `BeanInfo -> PropertyDescriptor` 

   æœ€åæˆ‘ä»¬å°±æ‹¿åˆ°äº† `Handler`ï¼Œè¿™ä¸ª`Handler`çš„å®ç°ç±»æ˜¯ `BeanPropertyHandler` 

   å›åˆ°ä¸Šé¢çš„æ–¹æ³•ï¼Œç°åœ¨å·²ç»æœ‰äº† `Handler` 

   ```java
   protected Object getPropertyValue(PropertyTokenHolder tokens) throws BeansException {
      String propertyName = tokens.canonicalName;
      String actualName = tokens.actualName;
      // [1] ç›´æ¥è·å– handler,handlerç”¨äºè®¿é—®å±æ€§
      PropertyHandler ph = getLocalPropertyHandler(actualName);
   
      // å±æ€§æ˜¯å¦å­˜åœ¨æˆ–è€…ä¸å¯è¯»
      if (ph == null || !ph.isReadable()) {
         throw new NotReadablePropertyException(getRootClass(), this.nestedPath + propertyName);
      }
      try {
   
         // [2] ç›´æ¥è°ƒç”¨ propertyHandle#getValue è·å–å±æ€§å€¼
         Object value = ph.getValue();
   ```

   è·Ÿ `#getValue`

   ```java
   public Object getValue() throws Exception {
      // [1] ä»å±æ€§æè¿°ç¬¦ä¸­è·å– Method
      final Method readMethod = this.pd.getReadMethod();
   
      // [2] æ¸…é™¤æ–¹æ³•æƒé™ï¼Œç„¶åç›´æ¥è°ƒç”¨getæ–¹æ³•
      if (System.getSecurityManager() != null) {
         AccessController.doPrivileged((PrivilegedAction<Object>) () -> {
            ReflectionUtils.makeAccessible(readMethod);
            return null;
         });
         try {
            return AccessController.doPrivileged((PrivilegedExceptionAction<Object>) () ->
                  readMethod.invoke(getWrappedInstance(), (Object[]) null), acc);
         }
         catch (PrivilegedActionException pae) {
            throw pae.getException();
         }
      }
      else {
         ReflectionUtils.makeAccessible(readMethod);
         return readMethod.invoke(getWrappedInstance(), (Object[]) null);
      }
   }
   ```

   ç†Ÿæ‚‰å§ï¼Œä» `PropertyDescriptor`æ‹¿åˆ° `readMethod`ï¼Œç„¶ååå°„è°ƒç”¨ä¸€ä¸‹å°± ğŸ‘Œ

   ä½†è¿™æ²¡æœ‰ç»“æŸï¼Œå› ä¸ºè¿˜è¦å¤„ç† `keys`å‘¢ï¼Œç»§ç»­è¿½`getPropertyValue`

   ```java
   protected Object getPropertyValue(PropertyTokenHolder tokens) throws BeansException {
   		String propertyName = tokens.canonicalName;
   		String actualName = tokens.actualName;
   		// [1] ç›´æ¥è·å– handler,handlerç”¨äºè®¿é—®å±æ€§
   		PropertyHandler ph = getLocalPropertyHandler(actualName);
   
   		// å±æ€§æ˜¯å¦å­˜åœ¨æˆ–è€…ä¸å¯è¯»
   		if (ph == null || !ph.isReadable()) {
   			throw new NotReadablePropertyException(getRootClass(), this.nestedPath + propertyName);
   		}
   		try {
   
   			// [2] ç›´æ¥è°ƒç”¨ propertyHandle#getValue è·å–å±æ€§å€¼
   			Object value = ph.getValue();
   
   			// [3] è¿™é‡Œè¿˜æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œå°±æ˜¯åˆ¤æ–­tokenæ˜¯å¦å­˜åœ¨ï¼Œç„¶åå¦‚æœæ”¯æŒé›†åˆç±»å‹
   			// å¦‚æœå±æ€§å€¼ä¸ºnullï¼Œåˆ™new ä¸€ä¸ªé›†åˆç»™å®ƒ
   			// å¦‚æœä¸æ”¯æŒé›†åˆç±»å‹ï¼Œé‚£ä¹ˆ over~
   			// [NOTICE] å®ƒnewå‡ºæ¥çš„é›†åˆï¼Œå®ƒè¿˜æ˜¯ä¼šè°ƒç”¨ setDefaultValue æŠŠå€¼æ”¾è¿›å»
   
   			// key are not-null
   			if (tokens.keys != null) {
   				if (value == null) {
   					// the AutoGrowNestedPaths enabled
   					if (isAutoGrowNestedPaths()) {
   						// this value not null
   						value = setDefaultValue(new PropertyTokenHolder(tokens.actualName));
   					}
   					else {
   						throw new NullValueInNestedPathException(getRootClass(), this.nestedPath + propertyName,
   								"Cannot access indexed value of property referenced in indexed " +
   										"property path '" + propertyName + "': returned null");
   					}
   				}
   				StringBuilder indexedPropertyName = new StringBuilder(tokens.actualName);
   				// [4] ä¸‹é¢æ˜¯é‡å¤´æˆï¼Œä¹Ÿå°±æ˜¯å¤„ç†é›†åˆç±»å‹çš„å±æ€§
   				for (int i = 0; i < tokens.keys.length; i++) {
   					String key = tokens.keys[i];
   					if (value == null) {
   						throw new NullValueInNestedPathException(getRootClass(), this.nestedPath + propertyName,
   								"Cannot access indexed value of property referenced in indexed " +
   										"property path '" + propertyName + "': returned null");
   					}
   
   					// ç±»å‹æ˜¯ Array
   					//growArrayIfNecessary çš„ä½œç”¨æ˜¯å¦‚æœä½ çš„ index è¶Šç•Œå®ƒä¼šå¸®ä½ æ‰©å®¹, è´´å¿ƒå§ï¼Ÿ
   					else if (value.getClass().isArray()) {
   						int index = Integer.parseInt(key);
   						// æ‰©å®¹
   						value = growArrayIfNecessary(value, index, indexedPropertyName.toString());
   						// [NOTICE]è¿”å›ç´¢å¼•çš„å€¼ å¯èƒ½ä¸º nullï¼Œindex è¶Šç•Œåä¼šå¡«å……null
   						// å¦‚æœvalueæ˜¯ é›†åˆç±»çš„æ•°ç»„ï¼Œåˆ™ä¸å¯èƒ½æ˜¯nullï¼Œä¼šæ˜¯ä¸€ä¸ªæ–°çš„é›†åˆ
   						// å¦‚æœæ˜¯  BeanInstance[] é‚£å°±å¯èƒ½æ‹¿åˆ°nullï¼Œå¦‚æœindexè¶Šç•Œ
   						value = Array.get(value, index);
   					}
   					// ç±»å‹æ˜¯ List
   					else if (value instanceof List) {
   						int index = Integer.parseInt(key);
   						List<Object> list = (List<Object>) value;
   						growCollectionIfNecessary(list, index, indexedPropertyName.toString(), ph, i + 1);
   						// list å’Œä¸Šé¢æ˜¯ä¸€æ ·çš„
   						value = list.get(index);
   					}
   					// ç±»å‹æ˜¯ Set
   					else if (value instanceof Set) {
   						// Apply index to Iterator in case of a Set.
   						Set<Object> set = (Set<Object>) value;
   						int index = Integer.parseInt(key);
   						if (index < 0 || index >= set.size()) {
   							throw new InvalidPropertyException(getRootClass(), this.nestedPath + propertyName,
   									"Cannot get element with index " + index + " from Set of size " +
   											set.size() + ", accessed using property path '" + propertyName + "'");
   						}
   						Iterator<Object> it = set.iterator();
   						for (int j = 0; it.hasNext(); j++) {
   							Object elem = it.next();
   							if (j == index) {
   								value = elem;
   								break;
   							}
   						}
   					}
   					// ç±»å‹æ˜¯ Map
   					else if (value instanceof Map) {
   						Map<Object, Object> map = (Map<Object, Object>) value;
   						// è·å–keyçš„ç±»å‹
   						Class<?> mapKeyType = ph.getResolvableType().getNested(i + 1).asMap().resolveGeneric(0);
   						// IMPORTANT: Do not pass full property name in here - property editors
   						// must not kick in for map keys but rather only for map values.
   						TypeDescriptor typeDescriptor = TypeDescriptor.valueOf(mapKeyType);
   						// è½¬æ¢key çš„ç±»å‹
   						Object convertedMapKey = convertIfNecessary(null, null, key, mapKeyType, typeDescriptor);
   						// ç›´æ¥ä»mapä¸­æ‹¿åˆ°æ•°æ®
   						// [NOTICE] mapçš„æƒ…å†µæ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒåœ¨è¿™é‡Œä¸ä¼šæ£€æŸ¥ï¼Œæ˜¯å¦å­˜åœ¨keyï¼Œå®ƒä¸åƒé‚£äº›è‡ªå¢é•¿çš„é›†åˆ
   						// [NOTICE] åœ¨å¤–éƒ¨å¤„ç† valueä¸º nullçš„ æƒ…å†µï¼Œå› ä¸ºæ•°æ®ç±»å‹å¯èƒ½æ˜¯ map<String,List[]>
   						// å› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“ ä¸‹ä¸€ä¸ªkeyæ˜¯ä»€ä¹ˆï¼Œå› ä¸ºè¿™é‡Œä¸ä¼šä¼ å…¥æ‰€æœ‰çš„keyï¼Œwhy
   						// å½“æˆ‘ä»¬è°ƒç”¨çš„æ˜¯ setPropertyValueçš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ˜¯ map[key][1]
   						// æˆ‘ä»¬å°±å¾—å…ˆè°ƒç”¨ getPropertyValueï¼ˆ"map[key]"ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™æ‰§è¡Œå®Œè¿™é‡Œï¼Œå¤–é¢è¿˜æœ‰ä¸€ä¸ªkey é‚£å°±æ˜¯ 1
   						// æˆ‘ä»¬map#getåå¯èƒ½ä¸º nullï¼Œæ‰€ä»¥è¦åœ¨å¤–éƒ¨å¤„ç† map#get ä¸ºnull çš„æƒ…å†µï¼Œç»ˆäºæ˜ç™½äº† :goodï¼š
   						value = map.get(convertedMapKey);
   					}
   indexedPropertyName.append(PROPERTY_KEY_PREFIX).append(key).append(PROPERTY_KEY_SUFFIX);
   				}
   			}
   			return value;
   		}
   	}
   ```

   ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è·å–å±æ€§å€¼åï¼Œéœ€è¦å¤„ç†`keys`çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¦æ”¯æŒé›†åˆï¼Œå¯ä»¥çœ‹å‡º `spring` æ”¯æŒ

   + Array
   + List
   + Set
   + Map

   å››ç§é›†åˆç±»å‹

   åŒæ—¶ä¹Ÿæ”¯æŒé›†åˆæ‰©å®¹ï¼Œæ¯”å¦‚ list<list> å¯ä»¥è‡ªåŠ¨æ‰©å®¹

   

    